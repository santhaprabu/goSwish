<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mopt Admin - Analytics Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #1b7a91;
            --primary-light: rgba(27, 122, 145, 0.15);
            --bg-dark: #0f1419;
            --card-bg: #1a1f26;
            --card-border: rgba(255, 255, 255, 0.08);
            --text-white: #ffffff;
            --text-dim: rgba(255, 255, 255, 0.6);
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-dark);
            color: var(--text-white);
            min-height: 100vh;
            padding: 24px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header h1 i {
            color: var(--primary);
        }

        .header-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #156a7e;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--card-bg);
            color: var(--text-white);
            border: 1px solid var(--card-border);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 24px;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
        }

        .stat-card .icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            font-size: 20px;
        }

        .stat-card .icon.blue {
            background: var(--primary-light);
            color: var(--primary);
        }

        .stat-card .icon.green {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        .stat-card .icon.orange {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .stat-card .icon.purple {
            background: rgba(168, 85, 247, 0.15);
            color: #a855f7;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .stat-card .label {
            color: var(--text-dim);
            font-size: 14px;
            font-weight: 500;
        }

        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .chart-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 24px;
        }

        .chart-card h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-card h3 i {
            color: var(--primary);
        }

        /* Bar Chart */
        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .bar-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .bar-label {
            width: 100px;
            font-size: 13px;
            color: var(--text-dim);
            text-align: right;
            flex-shrink: 0;
        }

        .bar-track {
            flex: 1;
            height: 24px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #2da3bd);
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .bar-value {
            width: 40px;
            font-size: 14px;
            font-weight: 600;
            text-align: right;
            flex-shrink: 0;
        }

        /* Pie Chart */
        .pie-container {
            display: flex;
            align-items: center;
            gap: 32px;
            flex-wrap: wrap;
        }

        .pie-chart {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .pie-legend {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 4px;
        }

        .legend-label {
            font-size: 14px;
            color: var(--text-dim);
        }

        .legend-value {
            font-weight: 600;
            margin-left: auto;
        }

        /* Table */
        .table-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            overflow-x: auto;
        }

        .table-card h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-card h3 i {
            color: var(--primary);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--card-border);
        }

        th {
            color: var(--text-dim);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            font-size: 14px;
        }

        tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-homeowner {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        .badge-cleaner {
            background: rgba(27, 122, 145, 0.15);
            color: var(--primary);
        }

        .badge-pending {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .badge-confirmed {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        .badge-completed {
            background: rgba(27, 122, 145, 0.15);
            color: var(--primary);
        }

        .badge-cancelled {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .booking-details {
            font-size: 12px;
            color: var(--text-dim);
            margin-top: 4px;
        }

        .booking-price {
            font-weight: 700;
            color: var(--success);
        }

        .action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            margin-right: 4px;
            transition: all 0.2s;
        }

        .action-btn:hover {
            transform: translateY(-1px);
        }

        .action-btn.confirm {
            background: var(--success);
            color: white;
        }

        .action-btn.cancel {
            background: var(--danger);
            color: white;
        }

        .action-btn.view {
            background: var(--primary);
            color: white;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-dim);
        }

        .empty-state i {
            font-size: 40px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--card-border);
            padding-bottom: 12px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            color: var(--text-dim);
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .tab:hover {
            color: var(--text-white);
            background: rgba(255, 255, 255, 0.05);
        }

        .tab.active {
            color: var(--primary);
            background: var(--primary-light);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .last-updated {
            color: var(--text-dim);
            font-size: 13px;
            margin-bottom: 24px;
        }

        /* Activity Timeline */
        .timeline {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .timeline-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
        }

        .timeline-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 14px;
        }

        .timeline-content {
            flex: 1;
            min-width: 0;
        }

        .timeline-title {
            font-weight: 600;
            margin-bottom: 2px;
            font-size: 14px;
        }

        .timeline-meta {
            font-size: 12px;
            color: var(--text-dim);
            word-break: break-all;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 16px;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .pie-container {
                justify-content: center;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-actions {
                width: 100%;
            }
        }

        /* Auth Overlay */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .auth-overlay.hidden {
            display: none;
        }

        .auth-modal {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 360px;
            text-align: center;
        }

        .auth-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 28px;
            color: var(--primary);
        }

        .auth-modal h2 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .auth-modal p {
            color: var(--text-dim);
            font-size: 14px;
            margin-bottom: 24px;
        }

        .auth-modal input {
            width: 100%;
            padding: 14px 16px;
            border-radius: 10px;
            border: 1px solid var(--card-border);
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-white);
            font-size: 16px;
            font-family: inherit;
            margin-bottom: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        .auth-modal input:focus {
            border-color: var(--primary);
        }

        .auth-error {
            color: var(--danger);
            font-size: 13px;
            margin-top: 12px;
            min-height: 20px;
        }

        .main-content-hidden {
            display: none;
        }

        .main-content-visible {
            display: block;
        }

        /* Booking Detail View */
        .booking-detail-view {
            display: none;
        }

        .booking-detail-view.active {
            display: block;
        }

        .detail-back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid var(--card-border);
            color: var(--text-white);
            border-radius: 10px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .detail-back-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 24px;
        }

        .detail-header-left h2 {
            margin: 0 0 6px;
            font-size: 24px;
        }

        .detail-header-left .detail-meta {
            color: var(--text-dim);
            font-size: 13px;
        }

        .detail-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .detail-actions .btn {
            font-size: 14px;
            padding: 8px 18px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .detail-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 24px;
        }

        .detail-card h3 {
            font-size: 16px;
            margin: 0 0 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
        }

        .detail-card h3 i {
            font-size: 18px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            gap: 12px;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: var(--text-dim);
            font-size: 13px;
            font-weight: 500;
            min-width: 110px;
            flex-shrink: 0;
        }

        .detail-value {
            font-weight: 600;
            text-align: right;
            word-break: break-word;
        }

        .detail-value.highlight {
            color: var(--success);
            font-size: 18px;
        }

        .detail-notes {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 16px;
            margin-top: 8px;
            color: var(--text-dim);
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        /* Edit Mode */
        .edit-input {
            width: 100%;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--card-border);
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-white);
            font-size: 14px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.3s;
        }

        .edit-input:focus {
            border-color: var(--primary);
        }

        .edit-select {
            width: 100%;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--card-border);
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-white);
            font-size: 14px;
            font-family: inherit;
            outline: none;
        }

        .edit-textarea {
            width: 100%;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--card-border);
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-white);
            font-size: 14px;
            font-family: inherit;
            outline: none;
            min-height: 80px;
            resize: vertical;
        }

        .edit-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .status-select-wrapper {
            display: inline-block;
        }

        .btn-edit {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .btn-edit:hover {
            background: rgba(245, 158, 11, 0.3);
        }

        .btn-delete {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .btn-delete:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .btn-save {
            background: var(--success);
            color: white;
        }

        .btn-cancel-edit {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-white);
        }

        /* Cleaner Management */
        .cleaners-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 20px;
        }

        .cleaners-toolbar .search-box {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid var(--card-border);
            border-radius: 10px;
            padding: 8px 14px;
            flex: 1;
            max-width: 350px;
        }

        .cleaners-toolbar .search-box i {
            color: var(--text-dim);
            font-size: 14px;
        }

        .cleaners-toolbar .search-box input {
            background: none;
            border: none;
            color: var(--text-white);
            font-family: inherit;
            font-size: 14px;
            outline: none;
            width: 100%;
        }

        .cleaners-toolbar .search-box input::placeholder {
            color: var(--text-dim);
        }

        .filter-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 6px 14px;
            border-radius: 8px;
            border: 1px solid var(--card-border);
            background: none;
            color: var(--text-dim);
            font-family: inherit;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            color: var(--text-white);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .filter-btn.active {
            color: var(--primary);
            background: var(--primary-light);
            border-color: var(--primary);
        }

        .badge-active {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        .badge-inactive {
            background: rgba(156, 163, 175, 0.15);
            color: #9ca3af;
        }

        .badge-suspended {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .cleaner-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary-light);
            color: var(--primary);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            flex-shrink: 0;
        }

        .cleaner-name-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .star-rating {
            color: #f59e0b;
            font-size: 13px;
            letter-spacing: 1px;
        }

        .service-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            margin: 2px;
            background: rgba(27, 122, 145, 0.12);
            color: var(--primary);
        }

        .area-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            margin: 2px;
            background: rgba(245, 158, 11, 0.12);
            color: var(--warning);
        }

        .avail-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            margin: 2px;
            background: rgba(34, 197, 94, 0.12);
            color: var(--success);
        }

        .cleaner-stat-row {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .cleaner-stat {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 16px 24px;
            text-align: center;
            flex: 1;
            min-width: 120px;
        }

        .cleaner-stat .value {
            font-size: 28px;
            font-weight: 800;
        }

        .cleaner-stat .label {
            color: var(--text-dim);
            font-size: 13px;
            margin-top: 4px;
        }

        .checkbox-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.04);
            cursor: pointer;
            transition: all 0.2s;
        }

        .checkbox-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .checkbox-item input[type="checkbox"] {
            accent-color: var(--primary);
        }

        .checkbox-item label {
            font-size: 13px;
            cursor: pointer;
            font-weight: 500;
        }

        .badge-in-progress {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        .assigned-cleaner-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 8px;
            background: rgba(27, 122, 145, 0.12);
            color: var(--primary);
            font-size: 12px;
            font-weight: 600;
        }

        .assigned-cleaner-badge .cleaner-avatar {
            width: 22px;
            height: 22px;
            font-size: 10px;
        }

        .unassigned-label {
            color: var(--text-dim);
            font-size: 12px;
            font-style: italic;
        }

        .inline-assign {
            position: relative;
            display: inline-block;
        }

        .inline-assign select {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid var(--card-border);
            color: var(--text-white);
            font-family: inherit;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            max-width: 140px;
        }

        .inline-assign select:focus {
            border-color: var(--primary);
            outline: none;
        }
    </style>
</head>

<body>
    <!-- Password Protection Overlay -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-modal">
            <div class="auth-icon">
                <i class="fas fa-lock"></i>
            </div>
            <h2>Admin Access</h2>
            <p>Enter password to continue</p>
            <form id="authForm" onsubmit="return checkPassword(event)">
                <input type="password" id="adminPassword" placeholder="Password" autocomplete="off" autofocus>
                <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">
                    <i class="fas fa-unlock"></i> Unlock
                </button>
            </form>
            <p id="authError" class="auth-error"></p>
        </div>
    </div>

    <div id="mainContent" class="main-content-hidden">
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> Mopt Analytics</h1>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="btn btn-primary" onclick="exportData()">
                    <i class="fas fa-download"></i> Export JSON
                </button>
                <button class="btn btn-primary" onclick="exportCSV()">
                    <i class="fas fa-file-csv"></i> Export CSV
                </button>
                <button class="btn btn-danger" onclick="clearData()">
                    <i class="fas fa-trash"></i> Clear
                </button>
            </div>
        </div>

        <p class="last-updated" id="lastUpdated">Last updated: --</p>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="overview">Overview</button>
            <button class="tab" data-tab="bookings">Bookings</button>
            <button class="tab" data-tab="cleaners">Cleaners</button>
            <button class="tab" data-tab="submissions">Waitlist</button>
            <button class="tab" data-tab="visits">Visits</button>
            <button class="tab" data-tab="activity">Activity</button>
        </div>

        <!-- Overview Tab -->
        <div class="tab-content active" id="tab-overview">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="icon blue"><i class="fas fa-eye"></i></div>
                    <div class="value" id="totalVisits">0</div>
                    <div class="label">Total Visits</div>
                </div>
                <div class="stat-card">
                    <div class="icon green"><i class="fas fa-envelope"></i></div>
                    <div class="value" id="totalSubmissions">0</div>
                    <div class="label">Waitlist Signups</div>
                </div>
                <div class="stat-card">
                    <div class="icon orange"><i class="fas fa-house"></i></div>
                    <div class="value" id="homeownerCount">0</div>
                    <div class="label">Homeowners</div>
                </div>
                <div class="stat-card">
                    <div class="icon blue"><i class="fas fa-broom"></i></div>
                    <div class="value" id="cleanerCount">0</div>
                    <div class="label">Cleaners</div>
                </div>
                <div class="stat-card">
                    <div class="icon purple"><i class="fas fa-percentage"></i></div>
                    <div class="value" id="conversionRate">0%</div>
                    <div class="label">Conversion Rate</div>
                </div>
                <div class="stat-card">
                    <div class="icon green"><i class="fas fa-calendar-check"></i></div>
                    <div class="value" id="totalBookings">0</div>
                    <div class="label">Total Bookings</div>
                </div>
                <div class="stat-card">
                    <div class="icon orange"><i class="fas fa-clock"></i></div>
                    <div class="value" id="pendingBookings">0</div>
                    <div class="label">Pending Bookings</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h3><i class="fas fa-map-marker-alt"></i> Signups by State</h3>
                    <div class="bar-chart" id="stateChart"></div>
                </div>

                <div class="chart-card">
                    <h3><i class="fas fa-mobile-alt"></i> Device Breakdown</h3>
                    <div class="pie-container" id="deviceChart"></div>
                </div>

                <div class="chart-card">
                    <h3><i class="fas fa-link"></i> Traffic Sources</h3>
                    <div class="bar-chart" id="referrerChart"></div>
                </div>

                <div class="chart-card">
                    <h3><i class="fas fa-calendar"></i> Daily Visits (Last 7 Days)</h3>
                    <div class="bar-chart" id="dailyChart"></div>
                </div>
            </div>
        </div>

        <!-- Bookings Tab -->
        <div class="tab-content" id="tab-bookings">
            <!-- Bookings List View -->
            <div id="bookingsListView">
                <div class="table-card">
                    <h3><i class="fas fa-calendar-check"></i> Booking Requests</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Booking ID</th>
                                <th>Date/Time</th>
                                <th>Customer</th>
                                <th>Service</th>
                                <th>Address</th>
                                <th>Total</th>
                                <th>Assigned Cleaner</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bookingsTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Booking Detail View -->
            <div id="bookingDetailView" class="booking-detail-view">
                <button class="detail-back-btn" onclick="backToBookingsList()">
                    <i class="fas fa-arrow-left"></i> Back to Bookings
                </button>
                <div id="bookingDetailContent"></div>
            </div>
        </div>

        <!-- Submissions Tab -->
        <div class="tab-content" id="tab-submissions">
            <div class="table-card">
                <h3><i class="fas fa-users"></i> Waitlist Submissions</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>State</th>
                        </tr>
                    </thead>
                    <tbody id="submissionsTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Visits Tab -->
        <div class="tab-content" id="tab-visits">
            <div class="table-card">
                <h3><i class="fas fa-eye"></i> Recent Visits</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Date/Time</th>
                            <th>Device</th>
                            <th>Browser</th>
                            <th>Source</th>
                            <th>Scroll</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody id="visitsTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Cleaners Tab -->
        <div class="tab-content" id="tab-cleaners">
            <!-- Cleaners List View -->
            <div id="cleanersListView">
                <div class="cleaner-stat-row" id="cleanerStats"></div>
                <div class="cleaners-toolbar">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="cleanerSearch" placeholder="Search cleaners..."
                            oninput="filterCleaners()">
                    </div>
                    <div class="filter-group">
                        <button class="filter-btn active" onclick="setCleanerFilter('all', this)">All</button>
                        <button class="filter-btn" onclick="setCleanerFilter('active', this)">Active</button>
                        <button class="filter-btn" onclick="setCleanerFilter('inactive', this)">Inactive</button>
                        <button class="filter-btn" onclick="setCleanerFilter('suspended', this)">Suspended</button>
                    </div>
                    <button class="btn btn-primary" onclick="showAddCleaner()">
                        <i class="fas fa-plus"></i> Add Cleaner
                    </button>
                </div>
                <div class="table-card">
                    <table>
                        <thead>
                            <tr>
                                <th>Cleaner</th>
                                <th>Contact</th>
                                <th>Services</th>
                                <th>Areas</th>
                                <th>Rate</th>
                                <th>Rating</th>
                                <th>Jobs</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="cleanersTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Cleaner Detail View -->
            <div id="cleanerDetailView" class="booking-detail-view">
                <button class="detail-back-btn" onclick="backToCleanersList()">
                    <i class="fas fa-arrow-left"></i> Back to Cleaners
                </button>
                <div id="cleanerDetailContent"></div>
            </div>
        </div>

        <!-- Activity Tab -->
        <div class="tab-content" id="tab-activity">
            <div class="chart-card">
                <h3><i class="fas fa-mouse-pointer"></i> Recent Activity</h3>
                <div class="timeline" id="activityTimeline"></div>
            </div>
        </div>

        <script>
            const ANALYTICS_KEY = 'mopt_analytics';
            const WAITLIST_KEY = 'mopt_waitlist';
            const BOOKINGS_KEY = 'mopt_bookings';
            const CLEANERS_KEY = 'mopt_cleaners';

            let currentCleanerFilter = 'all';

            function getBookings() {
                try {
                    return JSON.parse(localStorage.getItem(BOOKINGS_KEY)) || [];
                } catch (e) {
                    return [];
                }
            }

            function saveBookings(bookings) {
                localStorage.setItem(BOOKINGS_KEY, JSON.stringify(bookings));
            }

            function getCleaners() {
                try {
                    return JSON.parse(localStorage.getItem(CLEANERS_KEY)) || [];
                } catch (e) {
                    return [];
                }
            }

            function saveCleaners(cleaners) {
                localStorage.setItem(CLEANERS_KEY, JSON.stringify(cleaners));
            }

            function getAnalytics() {
                try {
                    return JSON.parse(localStorage.getItem(ANALYTICS_KEY)) || {
                        visits: [],
                        submissions: [],
                        clicks: [],
                        summary: {
                            totalVisits: 0,
                            totalSubmissions: 0,
                            homeownerSubmissions: 0,
                            cleanerSubmissions: 0,
                            stateBreakdown: {},
                            deviceBreakdown: { desktop: 0, mobile: 0, tablet: 0 },
                            referrerBreakdown: {},
                            dailyVisits: {}
                        }
                    };
                } catch (e) {
                    return { visits: [], submissions: [], clicks: [], summary: {} };
                }
            }

            function getWaitlist() {
                try {
                    return JSON.parse(localStorage.getItem(WAITLIST_KEY)) || [];
                } catch (e) {
                    return [];
                }
            }

            function refreshData() {
                const analytics = getAnalytics();
                const waitlist = getWaitlist();
                const bookings = getBookings();
                const summary = analytics.summary || {};

                document.getElementById('lastUpdated').textContent =
                    'Last updated: ' + new Date().toLocaleString();

                // Update bookings stats
                const totalBookings = bookings.length;
                const pendingBookings = bookings.filter(b => b.status === 'pending').length;
                document.getElementById('totalBookings').textContent = totalBookings;
                document.getElementById('pendingBookings').textContent = pendingBookings;

                // Merge waitlist into submissions if not already
                const allSubmissions = [...(analytics.submissions || [])];
                waitlist.forEach(w => {
                    if (!allSubmissions.find(s => s.email === w.email)) {
                        allSubmissions.push({
                            timestamp: w.timestamp,
                            email: w.email,
                            role: w.role,
                            state: w.state
                        });
                    }
                });

                // Count from merged submissions
                const homeowners = allSubmissions.filter(s => s.role === 'homeowner').length;
                const cleaners = allSubmissions.filter(s => s.role === 'cleaner').length;
                const totalVisits = summary.totalVisits || analytics.visits?.length || 0;

                document.getElementById('totalVisits').textContent = totalVisits;
                document.getElementById('totalSubmissions').textContent = allSubmissions.length;
                document.getElementById('homeownerCount').textContent = homeowners;
                document.getElementById('cleanerCount').textContent = cleaners;

                const convRate = totalVisits > 0 ? Math.round((allSubmissions.length / totalVisits) * 100) : 0;
                document.getElementById('conversionRate').textContent = convRate + '%';

                // State breakdown from all submissions
                const stateBreakdown = {};
                allSubmissions.forEach(s => {
                    stateBreakdown[s.state] = (stateBreakdown[s.state] || 0) + 1;
                });
                renderBarChart('stateChart', stateBreakdown);

                renderPieChart('deviceChart', summary.deviceBreakdown || {});
                renderBarChart('referrerChart', summary.referrerBreakdown || {});
                renderDailyChart('dailyChart', summary.dailyVisits || {});
                renderSubmissionsTable(allSubmissions);
                renderVisitsTable(analytics.visits || []);
                renderActivityTimeline(analytics, waitlist, bookings);
                renderBookingsTable(bookings);
                renderCleanersTable();
            }

            function renderBarChart(containerId, data) {
                const container = document.getElementById(containerId);
                if (!container) return;

                const entries = Object.entries(data).sort((a, b) => b[1] - a[1]);
                const maxValue = Math.max(...entries.map(e => e[1]), 1);

                if (entries.length === 0) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-chart-bar"></i><p>No data yet</p></div>';
                    return;
                }

                container.innerHTML = entries.slice(0, 6).map(([label, value]) => {
                    const percentage = (value / maxValue) * 100;
                    return `
                    <div class="bar-item">
                        <span class="bar-label">${label}</span>
                        <div class="bar-track">
                            <div class="bar-fill" style="width: ${percentage}%"></div>
                        </div>
                        <span class="bar-value">${value}</span>
                    </div>
                `;
                }).join('');
            }

            function renderPieChart(containerId, data) {
                const container = document.getElementById(containerId);
                if (!container) return;

                const total = Object.values(data).reduce((a, b) => a + b, 0) || 1;
                const colors = { desktop: '#1b7a91', mobile: '#22c55e', tablet: '#f59e0b' };
                const entries = Object.entries(data).filter(([_, v]) => v > 0);

                let gradientStops = [];
                let currentDeg = 0;

                entries.forEach(([key, value]) => {
                    const deg = (value / total) * 360;
                    gradientStops.push(`${colors[key] || '#666'} ${currentDeg}deg ${currentDeg + deg}deg`);
                    currentDeg += deg;
                });

                const gradient = gradientStops.length > 0
                    ? `conic-gradient(${gradientStops.join(', ')})`
                    : 'conic-gradient(#333 0deg 360deg)';

                container.innerHTML = `
                <div class="pie-chart" style="background: ${gradient}"></div>
                <div class="pie-legend">
                    ${entries.map(([key, value]) => `
                        <div class="legend-item">
                            <div class="legend-color" style="background: ${colors[key] || '#666'}"></div>
                            <span class="legend-label">${key.charAt(0).toUpperCase() + key.slice(1)}</span>
                            <span class="legend-value">${value} (${Math.round((value / total) * 100)}%)</span>
                        </div>
                    `).join('')}
                </div>
            `;
            }

            function renderDailyChart(containerId, data) {
                const dates = [];
                for (let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    dates.push(d.toISOString().split('T')[0]);
                }

                const chartData = {};
                dates.forEach(date => {
                    const dayLabel = new Date(date).toLocaleDateString('en-US', { weekday: 'short', day: 'numeric' });
                    chartData[dayLabel] = data[date] || 0;
                });

                renderBarChart(containerId, chartData);
            }

            function renderSubmissionsTable(submissions) {
                const tbody = document.getElementById('submissionsTable');
                if (!tbody) return;

                if (submissions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No submissions yet</td></tr>';
                    return;
                }

                tbody.innerHTML = submissions.slice().reverse().slice(0, 100).map(sub => `
                <tr>
                    <td>${new Date(sub.timestamp).toLocaleString()}</td>
                    <td>${sub.email}</td>
                    <td><span class="badge badge-${sub.role}">${sub.role}</span></td>
                    <td>${sub.state || 'N/A'}</td>
                </tr>
            `).join('');
            }

            function renderVisitsTable(visits) {
                const tbody = document.getElementById('visitsTable');
                if (!tbody) return;

                if (visits.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No visits yet</td></tr>';
                    return;
                }

                tbody.innerHTML = visits.slice().reverse().slice(0, 100).map(v => `
                <tr>
                    <td>${new Date(v.timestamp).toLocaleString()}</td>
                    <td>${v.device || 'Unknown'}</td>
                    <td>${v.browser || 'Unknown'}</td>
                    <td>${v.referrerCategory || 'Direct'}</td>
                    <td>${v.maxScrollDepth || 0}%</td>
                    <td>${v.timeOnPage || 0}s</td>
                </tr>
            `).join('');
            }

            function getCleanerDisplayName(cleanerId) {
                if (!cleanerId) return null;
                const cleaners = getCleaners();
                const c = cleaners.find(cl => cl.cleanerId === cleanerId);
                if (!c) return null;
                return { name: `${c.firstName} ${c.lastName}`, initials: getInitials(c.firstName, c.lastName), cleanerId: c.cleanerId };
            }

            function buildCleanerAssignOptions(selectedCleanerId) {
                const cleaners = getCleaners().filter(c => c.status === 'active');
                let opts = `<option value="">-- Unassigned --</option>`;
                cleaners.forEach(c => {
                    const selected = c.cleanerId === selectedCleanerId ? 'selected' : '';
                    opts += `<option value="${c.cleanerId}" ${selected}>${c.firstName} ${c.lastName}</option>`;
                });
                return opts;
            }

            function assignCleanerToBooking(bookingId, cleanerId) {
                const bookings = getBookings();
                const idx = bookings.findIndex(b => b.bookingId === bookingId);
                if (idx === -1) return;
                bookings[idx].assignedCleanerId = cleanerId || null;
                // Auto-set to confirmed when a cleaner is assigned
                if (cleanerId && bookings[idx].status === 'pending') {
                    bookings[idx].status = 'confirmed';
                }
                // If unassigned, revert to pending
                if (!cleanerId && bookings[idx].status === 'confirmed') {
                    bookings[idx].status = 'pending';
                }
                bookings[idx].updatedAt = new Date().toISOString();
                saveBookings(bookings);
                refreshData();
            }

            function buildStatusOptions(currentStatus) {
                const statuses = ['pending', 'confirmed', 'in-progress', 'completed', 'cancelled'];
                return statuses.map(s => {
                    const label = s.charAt(0).toUpperCase() + s.slice(1).replace('-', ' ');
                    return `<option value="${s}" ${currentStatus === s ? 'selected' : ''}>${label}</option>`;
                }).join('');
            }

            function renderBookingsTable(bookings) {
                const tbody = document.getElementById('bookingsTable');
                if (!tbody) return;

                if (bookings.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="empty-state"><i class="fas fa-calendar-xmark"></i><p>No bookings yet</p></td></tr>';
                    return;
                }

                tbody.innerHTML = bookings.slice().reverse().map(booking => {
                    const customerName = `${booking.contact?.firstName || ''} ${booking.contact?.lastName || ''}`.trim() || 'N/A';
                    const customerEmail = booking.contact?.email || '';
                    const serviceName = booking.service?.name || 'N/A';
                    const address = `${booking.property?.city || ''}`;
                    const fullAddress = `${booking.property?.address || ''}, ${booking.property?.city || ''} ${booking.property?.zipcode || ''}`;
                    const total = booking.pricing?.total || '$0.00';
                    const status = booking.status || 'pending';
                    const scheduleDate = booking.schedule?.date ? new Date(booking.schedule.date + 'T00:00:00').toLocaleDateString() : 'N/A';
                    const scheduleTime = booking.schedule?.timeRange || '';
                    const sqft = booking.property?.sqft || '';

                    // Assigned cleaner display
                    const cleanerInfo = getCleanerDisplayName(booking.assignedCleanerId);
                    const cleanerCell = cleanerInfo
                        ? `<span class="assigned-cleaner-badge"><span class="cleaner-avatar">${cleanerInfo.initials}</span>${cleanerInfo.name}</span>`
                        : `<div class="inline-assign"><select onchange="assignCleanerToBooking('${booking.bookingId}', this.value)">${buildCleanerAssignOptions(booking.assignedCleanerId)}</select></div>`;

                    return `
                    <tr>
                        <td>
                            <strong>${booking.bookingId || 'N/A'}</strong>
                            <div class="booking-details">${new Date(booking.createdAt).toLocaleString()}</div>
                        </td>
                        <td>
                            <strong>${scheduleDate}</strong>
                            <div class="booking-details">${scheduleTime}</div>
                        </td>
                        <td>
                            <strong>${customerName}</strong>
                            <div class="booking-details">${customerEmail}</div>
                        </td>
                        <td>
                            <strong>${serviceName}</strong>
                            <div class="booking-details">${sqft} sq ft</div>
                        </td>
                        <td>
                            <span title="${fullAddress}">${address}</span>
                        </td>
                        <td class="booking-price">${total}</td>
                        <td>${cleanerCell}</td>
                        <td>
                            ${booking.assignedCleanerId
                            ? `<div class="inline-assign"><select onchange="updateBookingStatus('${booking.bookingId}', this.value)">${buildStatusOptions(status)}</select></div>`
                            : `<span class="badge badge-${status}">${status}</span>`
                        }
                        </td>
                        <td>
                            ${!booking.assignedCleanerId && status === 'pending' ? `
                                <button class="action-btn confirm" onclick="updateBookingStatus('${booking.bookingId}', 'confirmed')">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="action-btn cancel" onclick="updateBookingStatus('${booking.bookingId}', 'cancelled')">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : ''}
                            <button class="action-btn view" onclick="viewBookingDetails('${booking.bookingId}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
                }).join('');
            }

            function updateBookingStatus(bookingId, newStatus, reloadDetail) {
                const bookings = getBookings();
                const bookingIndex = bookings.findIndex(b => b.bookingId === bookingId);
                if (bookingIndex !== -1) {
                    bookings[bookingIndex].status = newStatus;
                    bookings[bookingIndex].updatedAt = new Date().toISOString();
                    saveBookings(bookings);
                    refreshData();
                    if (reloadDetail) {
                        viewBookingDetails(bookingId);
                    }
                }
            }

            function viewBookingDetails(bookingId) {
                const bookings = getBookings();
                const booking = bookings.find(b => b.bookingId === bookingId);
                if (!booking) return;

                // Hide list, show detail
                document.getElementById('bookingsListView').style.display = 'none';
                const detailView = document.getElementById('bookingDetailView');
                detailView.classList.add('active');

                const status = booking.status || 'pending';
                const scheduleDate = booking.schedule?.date
                    ? new Date(booking.schedule.date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })
                    : 'N/A';
                const addons = booking.service?.addons?.length
                    ? booking.service.addons.map(a => a.charAt(0).toUpperCase() + a.slice(1).replace('-', ' ')).join(', ')
                    : 'None';

                document.getElementById('bookingDetailContent').innerHTML = `
                <div class="detail-header">
                    <div class="detail-header-left">
                        <h2><i class="fas fa-calendar-check" style="color:var(--primary)"></i> ${booking.bookingId || 'N/A'}</h2>
                        <div class="detail-meta">Created ${new Date(booking.createdAt).toLocaleString()}${booking.updatedAt ? '  Updated ' + new Date(booking.updatedAt).toLocaleString() : ''}</div>
                    </div>
                    <div class="detail-actions">
                        <button class="btn btn-edit" onclick="editBooking('${booking.bookingId}')">
                            <i class="fas fa-pen"></i> Edit
                        </button>
                        <button class="btn btn-delete" onclick="deleteBooking('${booking.bookingId}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>

                <div class="detail-grid">
                    <!-- Status & Pricing -->
                    <div class="detail-card">
                        <h3><i class="fas fa-info-circle"></i> Status & Pricing</h3>
                        <div class="detail-row">
                            <span class="detail-label">Status</span>
                            <span class="detail-value">
                                <div class="inline-assign">
                                    <select onchange="updateBookingStatus('${booking.bookingId}', this.value, true)" style="padding:6px 10px;font-size:13px">
                                        ${buildStatusOptions(status)}
                                    </select>
                                </div>
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Estimated Total</span>
                            <span class="detail-value highlight">${booking.pricing?.total || '$0.00'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Estimated Cleaner Payment</span>
                            <span class="detail-value" style="color:var(--success);font-weight:700">${(() => {
                        const totalStr = (booking.pricing?.total || '$0').replace(/[^0-9.]/g, '');
                        const totalNum = parseFloat(totalStr) || 0;
                        const subtotal = totalNum / 1.0825;
                        const cleanerPay = subtotal * 0.9;
                        return '$' + cleanerPay.toFixed(2);
                    })()}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label" style="font-size:11px;color:var(--text-dim)">90% of pre-tax service fee</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Mopt Revenue</span>
                            <span class="detail-value" style="color:var(--warning);font-weight:700">${(() => {
                        const totalStr = (booking.pricing?.total || '$0').replace(/[^0-9.]/g, '');
                        const totalNum = parseFloat(totalStr) || 0;
                        const subtotal = totalNum / 1.0825;
                        const platformFee = subtotal * 0.1;
                        return '$' + platformFee.toFixed(2);
                    })()}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label" style="font-size:11px;color:var(--text-dim)">10% of pre-tax service fee</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Tax (8.25%)</span>
                            <span class="detail-value">${(() => {
                        const totalStr = (booking.pricing?.total || '$0').replace(/[^0-9.]/g, '');
                        const totalNum = parseFloat(totalStr) || 0;
                        const subtotal = totalNum / 1.0825;
                        const tax = totalNum - subtotal;
                        return '$' + tax.toFixed(2);
                    })()}</span>
                        </div>
                    </div>

                    <!-- Assigned Cleaner -->
                    <div class="detail-card">
                        <h3><i class="fas fa-user-gear"></i> Assigned Cleaner</h3>
                        ${(() => {
                        const ci = getCleanerDisplayName(booking.assignedCleanerId);
                        if (ci) {
                            return `
                                    <div class="detail-row">
                                        <span class="detail-label">Cleaner</span>
                                        <span class="detail-value">
                                            <span class="assigned-cleaner-badge">
                                                <span class="cleaner-avatar">${ci.initials}</span>
                                                ${ci.name}
                                            </span>
                                        </span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Cleaner ID</span>
                                        <span class="detail-value">${ci.cleanerId}</span>
                                    </div>
                                    <div style="margin-top:8px">
                                        <button class="btn btn-edit" style="font-size:12px;padding:6px 12px" onclick="viewCleanerDetails('${ci.cleanerId}')">
                                            <i class="fas fa-eye"></i> View Cleaner Profile
                                        </button>
                                    </div>
                                `;
                        } else {
                            return `
                                    <div class="detail-row">
                                        <span class="detail-label">Cleaner</span>
                                        <span class="detail-value"><em class="unassigned-label">Not assigned</em></span>
                                    </div>
                                    <div style="margin-top:8px">
                                        <div class="inline-assign">
                                            <select onchange="assignCleanerToBooking('${booking.bookingId}', this.value); viewBookingDetails('${booking.bookingId}');" style="padding:6px 10px;font-size:13px">
                                                ${buildCleanerAssignOptions(booking.assignedCleanerId)}
                                            </select>
                                        </div>
                                    </div>
                                `;
                        }
                    })()}
                    </div>

                    <!-- Customer -->
                    <div class="detail-card">
                        <h3><i class="fas fa-user"></i> Customer</h3>
                        <div class="detail-row">
                            <span class="detail-label">Name</span>
                            <span class="detail-value">${booking.contact?.firstName || ''} ${booking.contact?.lastName || ''}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Email</span>
                            <span class="detail-value">${booking.contact?.email || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Phone</span>
                            <span class="detail-value">${booking.contact?.phone || 'N/A'}</span>
                        </div>
                    </div>

                    <!-- Property -->
                    <div class="detail-card">
                        <h3><i class="fas fa-house-chimney"></i> Property</h3>
                        <div class="detail-row">
                            <span class="detail-label">Address</span>
                            <span class="detail-value">${booking.property?.address || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">City / State</span>
                            <span class="detail-value">${booking.property?.city || 'N/A'}${booking.property?.state ? ', ' + booking.property.state : ''}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Zip Code</span>
                            <span class="detail-value">${booking.property?.zipcode || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Type</span>
                            <span class="detail-value">${(booking.property?.type || 'N/A').charAt(0).toUpperCase() + (booking.property?.type || '').slice(1)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Size</span>
                            <span class="detail-value">${booking.property?.sqft || 'N/A'} sq ft</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Bedrooms</span>
                            <span class="detail-value">${booking.property?.bedrooms || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Bathrooms</span>
                            <span class="detail-value">${booking.property?.bathrooms || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Pets</span>
                            <span class="detail-value">${booking.property?.hasPets ? 'Yes' + (booking.property?.petNotes ? '  ' + booking.property.petNotes : '') : 'No'}</span>
                        </div>
                    </div>

                    <!-- Service -->
                    <div class="detail-card">
                        <h3><i class="fas fa-wand-magic-sparkles"></i> Service</h3>
                        <div class="detail-row">
                            <span class="detail-label">Type</span>
                            <span class="detail-value">${booking.service?.name || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Add-ons</span>
                            <span class="detail-value">${addons}</span>
                        </div>
                    </div>

                    <!-- Schedule -->
                    <div class="detail-card">
                        <h3><i class="fas fa-calendar-days"></i> Schedule</h3>
                        <div class="detail-row">
                            <span class="detail-label">Date</span>
                            <span class="detail-value">${scheduleDate}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Time Window</span>
                            <span class="detail-value">${booking.schedule?.timeRange || 'N/A'}</span>
                        </div>
                    </div>

                    <!-- Notes & Access -->
                    <div class="detail-card">
                        <h3><i class="fas fa-clipboard-list"></i> Notes & Access</h3>
                        <div class="detail-row" style="flex-direction:column;gap:6px">
                            <span class="detail-label">Special Instructions</span>
                            <div class="detail-notes">${booking.notes || 'None'}</div>
                        </div>
                        <div class="detail-row" style="flex-direction:column;gap:6px">
                            <span class="detail-label">Access Instructions</span>
                            <div class="detail-notes">${booking.contact?.accessInstructions || 'None'}</div>
                        </div>
                    </div>

                    <!-- Admin Comment -->
                    <div class="detail-card" style="grid-column: 1 / -1">
                        <h3><i class="fas fa-comment-dots"></i> Admin Comment</h3>
                        <div style="display:flex;flex-direction:column;gap:10px">
                            <textarea id="adminCommentField" class="edit-textarea" rows="4" placeholder="Add any notes or comments about this booking...">${booking.adminComment || ''}</textarea>
                            <div style="display:flex;justify-content:flex-end">
                                <button type="button" class="btn btn-save" style="font-size:13px;padding:8px 18px" onclick="saveBookingComment('${booking.bookingId}')">
                                    <i class="fas fa-save"></i> Save Comment
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

                // Scroll to top of detail view
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
            function saveBookingComment(bookingId) {
                const comment = document.getElementById('adminCommentField')?.value || '';
                const bookings = getBookings();
                const idx = bookings.findIndex(b => b.bookingId === bookingId);
                if (idx === -1) return;
                bookings[idx].adminComment = comment;
                bookings[idx].updatedAt = new Date().toISOString();
                saveBookings(bookings);
                // Brief visual feedback
                const btn = event.target.closest('button');
                const origHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Saved!';
                btn.style.background = 'var(--success)';
                setTimeout(() => {
                    btn.innerHTML = origHTML;
                    btn.style.background = '';
                }, 1500);
            }

            function backToBookingsList() {
                document.getElementById('bookingsListView').style.display = 'block';
                document.getElementById('bookingDetailView').classList.remove('active');
            }

            function editBooking(bookingId) {
                const bookings = getBookings();
                const booking = bookings.find(b => b.bookingId === bookingId);
                if (!booking) return;

                const statusOptions = ['pending', 'confirmed', 'in-progress', 'completed', 'cancelled'].map(s =>
                    `<option value="${s}" ${booking.status === s ? 'selected' : ''}>${s.charAt(0).toUpperCase() + s.slice(1).replace('-', ' ')}</option>`
                ).join('');

                const propertyTypes = ['house', 'apartment', 'condo', 'townhouse'].map(t =>
                    `<option value="${t}" ${booking.property?.type === t ? 'selected' : ''}>${t.charAt(0).toUpperCase() + t.slice(1)}</option>`
                ).join('');

                const cleanerOptions = buildCleanerAssignOptions(booking.assignedCleanerId);

                document.getElementById('bookingDetailContent').innerHTML = `
                <div class="detail-header">
                    <div class="detail-header-left">
                        <h2><i class="fas fa-pen-to-square" style="color:var(--warning)"></i> Editing ${booking.bookingId}</h2>
                        <div class="detail-meta">Make changes and click Save</div>
                    </div>
                </div>

                <form id="editBookingForm" onsubmit="return saveBookingEdit(event, '${booking.bookingId}')">
                    <div class="detail-grid">
                        <!-- Status & Assignment -->
                        <div class="detail-card">
                            <h3><i class="fas fa-info-circle"></i> Status & Assignment</h3>
                            <div class="detail-row">
                                <span class="detail-label">Status</span>
                                <select class="edit-select" name="status">${statusOptions}</select>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Assigned Cleaner</span>
                                <select class="edit-select" name="assignedCleanerId">${cleanerOptions}</select>
                            </div>
                        </div>

                        <!-- Customer -->
                        <div class="detail-card">
                            <h3><i class="fas fa-user"></i> Customer</h3>
                            <div class="detail-row">
                                <span class="detail-label">First Name</span>
                                <input class="edit-input" name="firstName" value="${booking.contact?.firstName || ''}">
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Last Name</span>
                                <input class="edit-input" name="lastName" value="${booking.contact?.lastName || ''}">
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Email</span>
                                <input class="edit-input" name="email" type="email" value="${booking.contact?.email || ''}">
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Phone</span>
                                <input class="edit-input" name="phone" value="${booking.contact?.phone || ''}">
                            </div>
                        </div>

                        <!-- Property -->
                        <div class="detail-card">
                            <h3><i class="fas fa-house-chimney"></i> Property</h3>
                            <div class="detail-row">
                                <span class="detail-label">Address</span>
                                <input class="edit-input" name="address" value="${booking.property?.address || ''}">
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">City</span>
                                <input class="edit-input" name="city" value="${booking.property?.city || ''}">
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">State</span>
                                <input class="edit-input" name="state" value="${booking.property?.state || 'Texas'}">
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Zip Code</span>
                                <input class="edit-input" name="zipcode" value="${booking.property?.zipcode || ''}">
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Type</span>
                                <select class="edit-select" name="propertyType">${propertyTypes}</select>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Sq Ft</span>
                                <input class="edit-input" name="sqft" type="number" value="${booking.property?.sqft || ''}">
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Bedrooms</span>
                                <input class="edit-input" name="bedrooms" type="number" min="1" max="10" value="${booking.property?.bedrooms || ''}">
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Bathrooms</span>
                                <input class="edit-input" name="bathrooms" type="number" min="1" max="10" value="${booking.property?.bathrooms || ''}">
                            </div>
                        </div>

                        <!-- Schedule -->
                        <div class="detail-card">
                            <h3><i class="fas fa-calendar-days"></i> Schedule</h3>
                            <div class="detail-row">
                                <span class="detail-label">Date</span>
                                <input class="edit-input" name="date" type="date" value="${booking.schedule?.date || ''}">
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Time Slot</span>
                                <select class="edit-select" name="timeSlot">
                                    <option value="morning" ${booking.schedule?.timeSlot === 'morning' ? 'selected' : ''}>Morning (9 AM - 12 PM)</option>
                                    <option value="afternoon" ${booking.schedule?.timeSlot === 'afternoon' ? 'selected' : ''}>Afternoon (12 PM - 3 PM)</option>
                                    <option value="evening" ${booking.schedule?.timeSlot === 'evening' ? 'selected' : ''}>Evening (3 PM - 6 PM)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="detail-card">
                            <h3><i class="fas fa-clipboard-list"></i> Notes & Access</h3>
                            <div class="detail-row" style="flex-direction:column;gap:6px">
                                <span class="detail-label">Special Instructions</span>
                                <textarea class="edit-textarea" name="notes">${booking.notes || ''}</textarea>
                            </div>
                            <div class="detail-row" style="flex-direction:column;gap:6px">
                                <span class="detail-label">Access Instructions</span>
                                <textarea class="edit-textarea" name="accessInstructions">${booking.contact?.accessInstructions || ''}</textarea>
                            </div>
                        </div>
                    </div>

                    <div class="edit-actions">
                        <button type="button" class="btn btn-cancel-edit" onclick="viewBookingDetails('${booking.bookingId}')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="btn btn-save">
                            <i class="fas fa-check"></i> Save Changes
                        </button>
                    </div>
                </form>
            `;

                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            function saveBookingEdit(event, bookingId) {
                event.preventDefault();
                const form = document.getElementById('editBookingForm');
                const fd = new FormData(form);

                const bookings = getBookings();
                const idx = bookings.findIndex(b => b.bookingId === bookingId);
                if (idx === -1) return false;

                const booking = bookings[idx];

                // Update fields
                booking.status = fd.get('status');
                booking.assignedCleanerId = fd.get('assignedCleanerId') || null;
                booking.contact = booking.contact || {};
                booking.contact.firstName = fd.get('firstName');
                booking.contact.lastName = fd.get('lastName');
                booking.contact.email = fd.get('email');
                booking.contact.phone = fd.get('phone');
                booking.contact.accessInstructions = fd.get('accessInstructions');

                booking.property = booking.property || {};
                booking.property.address = fd.get('address');
                booking.property.city = fd.get('city');
                booking.property.state = fd.get('state');
                booking.property.zipcode = fd.get('zipcode');
                booking.property.type = fd.get('propertyType');
                booking.property.sqft = fd.get('sqft');
                booking.property.bedrooms = fd.get('bedrooms');
                booking.property.bathrooms = fd.get('bathrooms');

                const timeSlotMap = { morning: '9 AM - 12 PM', afternoon: '12 PM - 3 PM', evening: '3 PM - 6 PM' };
                booking.schedule = booking.schedule || {};
                booking.schedule.date = fd.get('date');
                booking.schedule.timeSlot = fd.get('timeSlot');
                booking.schedule.timeRange = timeSlotMap[fd.get('timeSlot')] || booking.schedule.timeRange;

                booking.notes = fd.get('notes');
                booking.updatedAt = new Date().toISOString();

                bookings[idx] = booking;
                saveBookings(bookings);
                refreshData();

                // Show updated detail view
                viewBookingDetails(bookingId);
                return false;
            }

            function deleteBooking(bookingId) {
                if (!confirm('Are you sure you want to permanently delete this booking? This cannot be undone.')) return;

                const bookings = getBookings().filter(b => b.bookingId !== bookingId);
                saveBookings(bookings);
                refreshData();
                backToBookingsList();
            }

            function renderActivityTimeline(analytics, waitlist, bookings = []) {
                const container = document.getElementById('activityTimeline');
                if (!container) return;

                const activities = [];

                (analytics.visits || []).forEach(v => {
                    activities.push({
                        type: 'visit',
                        timestamp: v.timestamp,
                        title: 'Page Visit',
                        meta: `${v.device || 'Unknown'}  ${v.browser || 'Unknown'}  ${v.referrerCategory || 'Direct'}`
                    });
                });

                waitlist.forEach(w => {
                    activities.push({
                        type: 'submission',
                        timestamp: w.timestamp,
                        title: `New ${w.role} signup`,
                        meta: `${w.email}  ${w.state || 'N/A'}`
                    });
                });

                (analytics.clicks || []).forEach(c => {
                    activities.push({
                        type: 'click',
                        timestamp: c.timestamp,
                        title: c.action || 'Click',
                        meta: c.element || ''
                    });
                });

                (bookings || []).forEach(b => {
                    activities.push({
                        type: 'booking',
                        timestamp: b.createdAt,
                        title: `New Booking: ${b.service?.name || 'Service'}`,
                        meta: `${b.contact?.firstName || ''} ${b.contact?.lastName || ''}  ${b.property?.city || ''}  ${b.pricing?.total || ''}`
                    });
                });

                activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                if (activities.length === 0) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-clock"></i><p>No activity yet</p></div>';
                    return;
                }

                const icons = {
                    visit: { icon: 'eye', bg: 'var(--primary-light)', color: 'var(--primary)' },
                    submission: { icon: 'envelope', bg: 'rgba(34, 197, 94, 0.15)', color: 'var(--success)' },
                    click: { icon: 'mouse-pointer', bg: 'rgba(245, 158, 11, 0.15)', color: 'var(--warning)' },
                    booking: { icon: 'calendar-check', bg: 'rgba(168, 85, 247, 0.15)', color: '#a855f7' }
                };

                container.innerHTML = activities.slice(0, 50).map(act => {
                    const i = icons[act.type] || icons.click;
                    return `
                    <div class="timeline-item">
                        <div class="timeline-icon" style="background: ${i.bg}; color: ${i.color}">
                            <i class="fas fa-${i.icon}"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-title">${act.title}</div>
                            <div class="timeline-meta">${act.meta}  ${new Date(act.timestamp).toLocaleString()}</div>
                        </div>
                    </div>
                `;
                }).join('');
            }

            function exportData() {
                const data = {
                    analytics: getAnalytics(),
                    waitlist: getWaitlist(),
                    bookings: getBookings(),
                    exportedAt: new Date().toISOString()
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `mopt-analytics-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }

            function exportCSV() {
                const waitlist = getWaitlist();
                const analytics = getAnalytics();
                const allSubmissions = [...waitlist];

                if (allSubmissions.length === 0) {
                    alert('No submissions to export');
                    return;
                }

                const headers = ['Date', 'Email', 'Role', 'State'];
                const rows = allSubmissions.map(s => [
                    new Date(s.timestamp).toLocaleString(),
                    s.email,
                    s.role,
                    s.state || ''
                ]);

                const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `mopt-waitlist-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            }

            function clearData() {
                if (confirm('Are you sure you want to clear ALL analytics, waitlist, bookings, and cleaners data? This cannot be undone.')) {
                    localStorage.removeItem(ANALYTICS_KEY);
                    localStorage.removeItem(WAITLIST_KEY);
                    localStorage.removeItem(BOOKINGS_KEY);
                    localStorage.removeItem(CLEANERS_KEY);
                    refreshData();
                }
            }

            // ========== CLEANER MANAGEMENT ==========

            const ALL_SERVICES = ['Standard Clean', 'Deep Clean', 'Move-In/Out', 'Post-Construction', 'Carpet Clean', 'Window Clean', 'Laundry', 'Organization'];
            const ALL_AREAS = ['Dallas', 'Fort Worth', 'Plano', 'Arlington', 'Irving', 'Frisco', 'McKinney', 'Denton', 'Richardson', 'Garland'];
            const ALL_DAYS = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

            function generateCleanerId() {
                return 'CLN-' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substring(2, 5).toUpperCase();
            }

            function getInitials(first, last) {
                return ((first || '')[0] || '').toUpperCase() + ((last || '')[0] || '').toUpperCase();
            }

            function renderStars(rating) {
                const full = Math.floor(rating);
                const half = rating % 1 >= 0.5 ? 1 : 0;
                const empty = 5 - full - half;
                return '<span class="star-rating">' +
                    ''.repeat(full) +
                    (half ? '' : '') +
                    ''.repeat(empty) +
                    '</span> <small style="color:var(--text-dim)">' + rating.toFixed(1) + '</small>';
            }

            function renderCleanerStats() {
                const cleaners = getCleaners();
                const total = cleaners.length;
                const active = cleaners.filter(c => c.status === 'active').length;
                const inactive = cleaners.filter(c => c.status === 'inactive').length;
                const suspended = cleaners.filter(c => c.status === 'suspended').length;
                const avgRating = total > 0 ? (cleaners.reduce((s, c) => s + (c.rating || 0), 0) / total).toFixed(1) : '0.0';

                document.getElementById('cleanerStats').innerHTML = `
                    <div class="cleaner-stat">
                        <div class="value" style="color:var(--text-white)">${total}</div>
                        <div class="label">Total Cleaners</div>
                    </div>
                    <div class="cleaner-stat">
                        <div class="value" style="color:var(--success)">${active}</div>
                        <div class="label">Active</div>
                    </div>
                    <div class="cleaner-stat">
                        <div class="value" style="color:#9ca3af">${inactive}</div>
                        <div class="label">Inactive</div>
                    </div>
                    <div class="cleaner-stat">
                        <div class="value" style="color:var(--danger)">${suspended}</div>
                        <div class="label">Suspended</div>
                    </div>
                    <div class="cleaner-stat">
                        <div class="value" style="color:var(--warning)"> ${avgRating}</div>
                        <div class="label">Avg Rating</div>
                    </div>
                `;
            }

            function renderCleanersTable() {
                renderCleanerStats();
                const cleaners = getCleaners();
                const tbody = document.getElementById('cleanersTable');
                if (!tbody) return;

                const search = (document.getElementById('cleanerSearch')?.value || '').toLowerCase();

                let filtered = cleaners.filter(c => {
                    if (currentCleanerFilter !== 'all' && c.status !== currentCleanerFilter) return false;
                    if (search) {
                        const searchStr = `${c.firstName} ${c.lastName} ${c.email} ${c.phone} ${(c.services || []).join(' ')} ${(c.areas || []).join(' ')}`.toLowerCase();
                        return searchStr.includes(search);
                    }
                    return true;
                });

                if (filtered.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="empty-state"><i class="fas fa-user-slash"></i><p>No cleaners found</p></td></tr>';
                    return;
                }

                tbody.innerHTML = filtered.map(c => {
                    const initials = getInitials(c.firstName, c.lastName);
                    const services = (c.services || []).slice(0, 2).map(s => `<span class="service-tag">${s}</span>`).join('');
                    const moreServices = (c.services || []).length > 2 ? `<span class="service-tag">+${c.services.length - 2}</span>` : '';
                    const areas = (c.areas || []).slice(0, 2).map(a => `<span class="area-tag">${a}</span>`).join('');
                    const moreAreas = (c.areas || []).length > 2 ? `<span class="area-tag">+${c.areas.length - 2}</span>` : '';

                    return `
                        <tr>
                            <td>
                                <div class="cleaner-name-cell">
                                    <span class="cleaner-avatar">${initials}</span>
                                    <div>
                                        <strong>${c.firstName} ${c.lastName}</strong>
                                        <div class="booking-details">${c.cleanerId}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div>${c.email || 'N/A'}</div>
                                <div class="booking-details">${c.phone || 'N/A'}</div>
                            </td>
                            <td>${services}${moreServices}</td>
                            <td>${areas}${moreAreas}</td>
                            <td class="booking-price">$${(c.hourlyRate || 0).toFixed(0)}/hr</td>
                            <td>${renderStars(c.rating || 0)}</td>
                            <td>${c.totalJobs || 0}</td>
                            <td><span class="badge badge-${c.status || 'inactive'}">${(c.status || 'inactive')}</span></td>
                            <td>
                                <button class="action-btn view" onclick="viewCleanerDetails('${c.cleanerId}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="action-btn confirm" onclick="editCleaner('${c.cleanerId}')">
                                    <i class="fas fa-pen"></i>
                                </button>
                                <button class="action-btn cancel" onclick="deleteCleaner('${c.cleanerId}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            function setCleanerFilter(filter, btn) {
                currentCleanerFilter = filter;
                document.querySelectorAll('#tab-cleaners .filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderCleanersTable();
            }

            function filterCleaners() {
                renderCleanersTable();
            }

            function viewCleanerDetails(cleanerId) {
                const cleaners = getCleaners();
                const c = cleaners.find(cl => cl.cleanerId === cleanerId);
                if (!c) return;

                document.getElementById('cleanersListView').style.display = 'none';
                document.getElementById('cleanerDetailView').classList.add('active');

                const services = (c.services || []).map(s => `<span class="service-tag">${s}</span>`).join('') || 'None';
                const areas = (c.areas || []).map(a => `<span class="area-tag">${a}</span>`).join('') || 'None';
                const availability = (c.availability || []).map(d => `<span class="avail-tag">${d}</span>`).join('') || 'Not set';
                const initials = getInitials(c.firstName, c.lastName);

                document.getElementById('cleanerDetailContent').innerHTML = `
                    <div class="detail-header">
                        <div class="detail-header-left" style="display:flex;align-items:center;gap:16px">
                            <span class="cleaner-avatar" style="width:56px;height:56px;font-size:22px">${initials}</span>
                            <div>
                                <h2 style="margin:0 0 4px">${c.firstName} ${c.lastName}</h2>
                                <div class="detail-meta">${c.cleanerId}  Joined ${new Date(c.createdAt).toLocaleDateString()}${c.updatedAt ? '  Updated ' + new Date(c.updatedAt).toLocaleDateString() : ''}</div>
                            </div>
                        </div>
                        <div class="detail-actions">
                            <button class="btn btn-edit" onclick="editCleaner('${c.cleanerId}')">
                                <i class="fas fa-pen"></i> Edit
                            </button>
                            <button class="btn btn-delete" onclick="deleteCleaner('${c.cleanerId}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>

                    <div class="detail-grid">
                        <div class="detail-card">
                            <h3><i class="fas fa-info-circle"></i> Status & Performance</h3>
                            <div class="detail-row">
                                <span class="detail-label">Status</span>
                                <span class="detail-value"><span class="badge badge-${c.status}">${c.status}</span></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Rating</span>
                                <span class="detail-value">${renderStars(c.rating || 0)}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Total Jobs</span>
                                <span class="detail-value">${c.totalJobs || 0}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Hourly Rate</span>
                                <span class="detail-value highlight">$${(c.hourlyRate || 0).toFixed(2)}/hr</span>
                            </div>
                        </div>

                        <div class="detail-card">
                            <h3><i class="fas fa-address-card"></i> Contact Info</h3>
                            <div class="detail-row">
                                <span class="detail-label">Email</span>
                                <span class="detail-value">${c.email || 'N/A'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Phone</span>
                                <span class="detail-value">${c.phone || 'N/A'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Address</span>
                                <span class="detail-value">${c.address || 'N/A'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">City / State</span>
                                <span class="detail-value">${c.city || 'N/A'}${c.state ? ', ' + c.state : ''}</span>
                            </div>
                        </div>

                        <div class="detail-card">
                            <h3><i class="fas fa-broom"></i> Services Offered</h3>
                            <div style="padding:8px 0">${services}</div>
                        </div>

                        <div class="detail-card">
                            <h3><i class="fas fa-map-location-dot"></i> Service Areas</h3>
                            <div style="padding:8px 0">${areas}</div>
                        </div>

                        <div class="detail-card">
                            <h3><i class="fas fa-clock"></i> Availability</h3>
                            <div style="padding:8px 0">${availability}</div>
                            <div class="detail-row">
                                <span class="detail-label">Preferred Hours</span>
                                <span class="detail-value">${c.preferredHours || 'Flexible'}</span>
                            </div>
                        </div>

                        <div class="detail-card">
                            <h3><i class="fas fa-clipboard-list"></i> Notes</h3>
                            <div class="detail-notes">${c.notes || 'No notes'}</div>
                        </div>
                    </div>
                `;

                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            function backToCleanersList() {
                document.getElementById('cleanersListView').style.display = 'block';
                document.getElementById('cleanerDetailView').classList.remove('active');
            }

            function renderCleanerForm(cleaner = null) {
                const isNew = !cleaner;
                const c = cleaner || { firstName: '', lastName: '', email: '', phone: '', address: '', city: '', state: 'Texas', hourlyRate: 25, rating: 0, totalJobs: 0, status: 'active', services: [], areas: [], availability: [], preferredHours: '', notes: '' };

                const statusOpts = ['active', 'inactive', 'suspended'].map(s =>
                    `<option value="${s}" ${c.status === s ? 'selected' : ''}>${s.charAt(0).toUpperCase() + s.slice(1)}</option>`
                ).join('');

                const servicesCheckboxes = ALL_SERVICES.map(s =>
                    `<div class="checkbox-item">
                        <input type="checkbox" id="svc_${s.replace(/\s/g, '_')}" name="services" value="${s}" ${(c.services || []).includes(s) ? 'checked' : ''}>
                        <label for="svc_${s.replace(/\s/g, '_')}">${s}</label>
                    </div>`
                ).join('');

                const areasCheckboxes = ALL_AREAS.map(a =>
                    `<div class="checkbox-item">
                        <input type="checkbox" id="area_${a.replace(/\s/g, '_')}" name="areas" value="${a}" ${(c.areas || []).includes(a) ? 'checked' : ''}>
                        <label for="area_${a.replace(/\s/g, '_')}">${a}</label>
                    </div>`
                ).join('');

                const availCheckboxes = ALL_DAYS.map(d =>
                    `<div class="checkbox-item">
                        <input type="checkbox" id="avail_${d}" name="availability" value="${d}" ${(c.availability || []).includes(d) ? 'checked' : ''}>
                        <label for="avail_${d}">${d}</label>
                    </div>`
                ).join('');

                const hoursOpts = ['Flexible', 'Morning (8 AM - 12 PM)', 'Afternoon (12 PM - 5 PM)', 'Evening (5 PM - 9 PM)', 'Full Day (8 AM - 5 PM)'].map(h =>
                    `<option value="${h}" ${c.preferredHours === h ? 'selected' : ''}>${h}</option>`
                ).join('');

                return `
                    <div class="detail-header">
                        <div class="detail-header-left">
                            <h2><i class="fas ${isNew ? 'fa-user-plus' : 'fa-pen-to-square'}" style="color:${isNew ? 'var(--success)' : 'var(--warning)'}"></i> ${isNew ? 'Add New Cleaner' : 'Edit ' + c.firstName + ' ' + c.lastName}</h2>
                            <div class="detail-meta">${isNew ? 'Fill in the details below' : 'Update details and click Save'}</div>
                        </div>
                    </div>

                    <form id="cleanerForm" onsubmit="return saveCleanerForm(event, '${isNew ? '' : c.cleanerId}')">
                        <div class="detail-grid">
                            <div class="detail-card">
                                <h3><i class="fas fa-user"></i> Personal Info</h3>
                                <div class="detail-row">
                                    <span class="detail-label">First Name *</span>
                                    <input class="edit-input" name="firstName" value="${c.firstName}" required>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Last Name *</span>
                                    <input class="edit-input" name="lastName" value="${c.lastName}" required>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Email *</span>
                                    <input class="edit-input" name="email" type="email" value="${c.email}" required>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Phone</span>
                                    <input class="edit-input" name="phone" value="${c.phone}">
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Address</span>
                                    <input class="edit-input" name="address" value="${c.address || ''}">
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">City</span>
                                    <input class="edit-input" name="city" value="${c.city || ''}">
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">State</span>
                                    <input class="edit-input" name="state" value="${c.state || 'Texas'}">
                                </div>
                            </div>

                            <div class="detail-card">
                                <h3><i class="fas fa-info-circle"></i> Status & Rate</h3>
                                <div class="detail-row">
                                    <span class="detail-label">Status</span>
                                    <select class="edit-select" name="status">${statusOpts}</select>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Hourly Rate ($)</span>
                                    <input class="edit-input" name="hourlyRate" type="number" step="0.01" min="0" value="${c.hourlyRate || 25}">
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Rating (0-5)</span>
                                    <input class="edit-input" name="rating" type="number" step="0.1" min="0" max="5" value="${c.rating || 0}">
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Total Jobs</span>
                                    <input class="edit-input" name="totalJobs" type="number" min="0" value="${c.totalJobs || 0}">
                                </div>
                            </div>

                            <div class="detail-card">
                                <h3><i class="fas fa-broom"></i> Services Offered</h3>
                                <div class="checkbox-grid">${servicesCheckboxes}</div>
                            </div>

                            <div class="detail-card">
                                <h3><i class="fas fa-map-location-dot"></i> Service Areas</h3>
                                <div class="checkbox-grid">${areasCheckboxes}</div>
                            </div>

                            <div class="detail-card">
                                <h3><i class="fas fa-clock"></i> Availability</h3>
                                <div class="checkbox-grid" style="margin-bottom:12px">${availCheckboxes}</div>
                                <div class="detail-row">
                                    <span class="detail-label">Preferred Hours</span>
                                    <select class="edit-select" name="preferredHours">${hoursOpts}</select>
                                </div>
                            </div>

                            <div class="detail-card">
                                <h3><i class="fas fa-clipboard-list"></i> Notes</h3>
                                <textarea class="edit-textarea" name="notes" placeholder="Internal notes about this cleaner...">${c.notes || ''}</textarea>
                            </div>
                        </div>

                        <div class="edit-actions">
                            <button type="button" class="btn btn-cancel-edit" onclick="${isNew ? 'backToCleanersList()' : 'viewCleanerDetails(\'' + c.cleanerId + '\')'}">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            <button type="submit" class="btn btn-save">
                                <i class="fas fa-check"></i> ${isNew ? 'Add Cleaner' : 'Save Changes'}
                            </button>
                        </div>
                    </form>
                `;
            }

            function showAddCleaner() {
                document.getElementById('cleanersListView').style.display = 'none';
                document.getElementById('cleanerDetailView').classList.add('active');
                document.getElementById('cleanerDetailContent').innerHTML = renderCleanerForm();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            function editCleaner(cleanerId) {
                const cleaners = getCleaners();
                const c = cleaners.find(cl => cl.cleanerId === cleanerId);
                if (!c) return;

                document.getElementById('cleanersListView').style.display = 'none';
                document.getElementById('cleanerDetailView').classList.add('active');
                document.getElementById('cleanerDetailContent').innerHTML = renderCleanerForm(c);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            function saveCleanerForm(event, cleanerId) {
                event.preventDefault();
                const form = document.getElementById('cleanerForm');
                const fd = new FormData(form);

                const checkedServices = Array.from(form.querySelectorAll('input[name="services"]:checked')).map(cb => cb.value);
                const checkedAreas = Array.from(form.querySelectorAll('input[name="areas"]:checked')).map(cb => cb.value);
                const checkedAvail = Array.from(form.querySelectorAll('input[name="availability"]:checked')).map(cb => cb.value);

                const cleaners = getCleaners();
                const isNew = !cleanerId;

                const data = {
                    firstName: fd.get('firstName'),
                    lastName: fd.get('lastName'),
                    email: fd.get('email'),
                    phone: fd.get('phone'),
                    address: fd.get('address'),
                    city: fd.get('city'),
                    state: fd.get('state'),
                    status: fd.get('status'),
                    hourlyRate: parseFloat(fd.get('hourlyRate')) || 25,
                    rating: parseFloat(fd.get('rating')) || 0,
                    totalJobs: parseInt(fd.get('totalJobs')) || 0,
                    services: checkedServices,
                    areas: checkedAreas,
                    availability: checkedAvail,
                    preferredHours: fd.get('preferredHours'),
                    notes: fd.get('notes'),
                    updatedAt: new Date().toISOString()
                };

                if (isNew) {
                    data.cleanerId = generateCleanerId();
                    data.createdAt = new Date().toISOString();
                    cleaners.push(data);
                } else {
                    const idx = cleaners.findIndex(c => c.cleanerId === cleanerId);
                    if (idx === -1) return false;
                    data.cleanerId = cleanerId;
                    data.createdAt = cleaners[idx].createdAt;
                    cleaners[idx] = data;
                }

                saveCleaners(cleaners);
                refreshData();
                viewCleanerDetails(data.cleanerId);
                return false;
            }

            function deleteCleaner(cleanerId) {
                if (!confirm('Are you sure you want to permanently delete this cleaner? This cannot be undone.')) return;

                const cleaners = getCleaners().filter(c => c.cleanerId !== cleanerId);
                saveCleaners(cleaners);
                refreshData();
                backToCleanersList();
            }

            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById('tab-' + this.dataset.tab).classList.add('active');
                });
            });

            // Initial load
            refreshData();
            setInterval(refreshData, 30000);
        </script>
    </div>

    <script>
        // Password protection - change this password
        const ADMIN_PASSWORD = 'mopt2026';
        const AUTH_KEY = 'mopt_admin_auth';
        const AUTH_EXPIRY = 24 * 60 * 60 * 1000; // 24 hours

        function checkAuth() {
            const authData = localStorage.getItem(AUTH_KEY);
            if (authData) {
                try {
                    const { timestamp } = JSON.parse(authData);
                    if (Date.now() - timestamp < AUTH_EXPIRY) {
                        unlockDashboard();
                        return;
                    }
                } catch (e) { }
            }
            // Show auth overlay
            document.getElementById('authOverlay').classList.remove('hidden');
        }

        function checkPassword(event) {
            event.preventDefault();
            const password = document.getElementById('adminPassword').value;
            const errorEl = document.getElementById('authError');

            if (password === ADMIN_PASSWORD) {
                localStorage.setItem(AUTH_KEY, JSON.stringify({ timestamp: Date.now() }));
                unlockDashboard();
            } else {
                errorEl.textContent = 'Incorrect password. Try again.';
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminPassword').focus();
            }
            return false;
        }

        function unlockDashboard() {
            document.getElementById('authOverlay').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('main-content-hidden');
            document.getElementById('mainContent').classList.add('main-content-visible');
        }

        // Check auth on load
        checkAuth();
    </script>
</body>

</html>